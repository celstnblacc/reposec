---
name: 7-Layer Security Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # Run security scans daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  # Layer 1: Dependencies - Detect vulnerable Python packages
  layer-1-python-deps:
    name: Layer 1 - Python Dependencies
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install pip-audit
        run: pip install pip-audit

      - name: Run pip-audit for Python dependencies
        if: hashFiles('requirements*.txt', 'pyproject.toml') != ''
        run: pip-audit --skip-editable || true

  # Layer 1: Dependencies - Detect vulnerable JavaScript packages
  layer-1-js-deps:
    name: Layer 1 - JavaScript Dependencies
    runs-on: ubuntu-latest
    if: hashFiles('package.json', 'package-lock.json', 'pnpm-lock.yaml', 'yarn.lock') != ''
    continue-on-error: true
    steps:
      - uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      - name: Run npm audit
        if: hashFiles('package-lock.json') != ''
        run: npm audit --audit-level=moderate || true

      - name: Run pnpm audit
        if: hashFiles('pnpm-lock.yaml') != ''
        run: |
          npm install -g pnpm
          pnpm audit || true

  # Layer 2: Secrets - Detect hardcoded credentials
  layer-2-secrets-gitleaks:
    name: Layer 2 - Detect Secrets (Gitleaks)
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2.3.4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

  # Layer 2: Secrets - RepoSec layer 2 specific rules
  layer-2-secrets-reposec:
    name: Layer 2 - Secrets (RepoSec)
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install RepoSec
        run: pip install -e .

      - name: Run RepoSec for Secrets (Layer 2)
        run: reposec scan . --severity critical --rules SEC-001,SEC-002,SEC-003 --format json > layer2-report.json || true
        continue-on-error: true

      - name: Upload Layer 2 Report
        uses: actions/upload-artifact@v3
        with:
          name: layer2-secrets-report
          path: layer2-report.json

  # Layer 3: SAST - Static Application Security Testing
  layer-3-sast:
    name: Layer 3 - SAST (RepoSec)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install RepoSec
        run: pip install -e .

      - name: Run RepoSec Full Scan (Layer 3)
        run: reposec scan . --format json > layer3-report.json
        continue-on-error: true

      - name: Check for Critical Findings
        run: |
          CRITICAL=$(grep -o '"severity":"critical"' layer3-report.json | wc -l)
          if [ "$CRITICAL" -gt 0 ]; then
            echo "Found $CRITICAL critical findings"
            exit 1
          fi
        continue-on-error: true

      - name: Upload Layer 3 Report
        uses: actions/upload-artifact@v3
        with:
          name: layer3-sast-report
          path: layer3-report.json

  # Layer 4: AI Reasoning - Comment reminder for manual review
  layer-4-ai-reasoning:
    name: Layer 4 - AI Reasoning Reminder
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Post PR Comment about AI Review
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ü§ñ **Layer 4: AI Reasoning** - Please conduct a manual security review, considering:\n- Authorization/authentication logic\n- Business logic vulnerabilities\n- Architectural patterns\n- Data handling and privacy\n\nUse an AI tool (Claude, GPT-4, etc.) or human architect for comprehensive review.'
            })
        continue-on-error: true

  # Layer 5: DAST - Dynamic Application Security Testing
  layer-5-dast:
    name: Layer 5 - DAST (OWASP ZAP)
    runs-on: ubuntu-latest
    if: vars.PREVIEW_URL != ''
    continue-on-error: true
    steps:
      - uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

      - name: Run OWASP ZAP Baseline Scan
        run: |
          docker run -t owasp/zap2docker-stable:latest \
            zap-baseline.py \
            -t "${{ vars.PREVIEW_URL }}" \
            -r layer5-zap-report.html \
            || true

      - name: Upload Layer 5 Report
        uses: actions/upload-artifact@v3
        with:
          name: layer5-dast-report
          path: layer5-zap-report.html
        if: always()

  # Layer 6: Supply Chain - Verify Docker images and dependency pinning
  layer-6-supply-chain:
    name: Layer 6 - Supply Chain Integrity
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install RepoSec
        run: pip install -e .

      - name: Check for Unpinned Docker Images
        run: reposec scan . --rules SC-001 --format json > layer6-docker-report.json || true
        continue-on-error: true

      - name: Check for Unpinned Python Dependencies
        run: reposec scan . --rules SC-002 --format json > layer6-python-deps-report.json || true
        continue-on-error: true

      - name: Check for npm/pnpm without Lockfile
        run: reposec scan . --rules SC-003 --format json > layer6-npm-lockfile-report.json || true
        continue-on-error: true

      - name: Verify Lockfiles
        run: |
          if [ -f "requirements.txt" ]; then
            echo "‚úì Python lockfile present"
          fi
          if [ -f "package-lock.json" ] || [ -f "pnpm-lock.yaml" ]; then
            echo "‚úì JavaScript lockfile present"
          fi
        continue-on-error: true

      - name: Upload Layer 6 Reports
        uses: actions/upload-artifact@v3
        with:
          name: layer6-supply-chain-reports
          path: layer6-*-report.json

  # Layer 7: Observability - Comment reminder for monitoring setup
  layer-7-observability:
    name: Layer 7 - Observability Reminder
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - name: Post Observability Reminder
        run: |
          echo "üìä Layer 7: Observability & Incident Response"
          echo "Ensure your deployment includes:"
          echo "- Security event logging"
          echo "- Real-time alerting for suspicious activities"
          echo "- SIEM integration"
          echo "- Incident response runbooks"
          echo "- Post-incident analysis process"
        continue-on-error: true

  # Summary Job
  security-summary:
    name: Security Pipeline Summary
    runs-on: ubuntu-latest
    needs: [layer-3-sast, layer-6-supply-chain]
    if: always()
    steps:
      - name: Download all reports
        uses: actions/download-artifact@v3

      - name: Print Security Summary
        run: |
          echo "================================"
          echo "7-Layer Security Pipeline Summary"
          echo "================================"
          echo "‚úÖ Layer 1: Dependencies - Checked"
          echo "‚úÖ Layer 2: Secrets - Checked"
          echo "‚úÖ Layer 3: SAST - Checked"
          echo "‚úÖ Layer 4: AI Reasoning - Review reminder sent"
          echo "‚ö†Ô∏è  Layer 5: DAST - Conditional (requires PREVIEW_URL)"
          echo "‚úÖ Layer 6: Supply Chain - Checked"
          echo "‚úÖ Layer 7: Observability - Reminder sent"
          echo "================================"
        continue-on-error: true
